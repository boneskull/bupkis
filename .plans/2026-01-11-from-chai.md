# @bupkis/from-chai Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a codemod package to migrate Chai (and popular ecosystem plugins) assertions to bupkis.

**Architecture:** Follow the same structure as `@bupkis/from-jest` with separate modules for types, matchers (BDD and TDD), transformers (expect/should and assert), main transform API, and CLI. The key challenge is handling Chai's chainable property API (`.to.be.true`) vs Jest's simple method calls.

**Tech Stack:** ts-morph (AST manipulation), @boneskull/bargs (CLI), bupkis (assertions for tests)

---

### Task 1: Package Scaffold

**Files:**
- Create: `packages/from-chai/package.json`
- Create: `packages/from-chai/tsconfig.json`
- Create: `packages/from-chai/LICENSE.md`
- Create: `packages/from-chai/README.md`

**Step 1: Create package.json**
```json
{
  "name": "@bupkis/from-chai",
  "version": "0.0.0",
  "type": "module",
  "description": "Migrate Chai assertions to bupkis",
  "repository": {
    "directory": "packages/from-chai",
    "type": "git",
    "url": "git+https://github.com/boneskull/bupkis.git"
  },
  "homepage": "https://bupkis.zip",
  "author": {
    "email": "boneskull@boneskull.com",
    "name": "Christopher Hiller"
  },
  "license": "BlueOak-1.0.0",
  "engines": {
    "node": "^20.19.0 || ^22.12.0 || >=23"
  },
  "bin": {
    "bupkis-from-chai": "./dist/cli.js"
  },
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "files": [
    "CHANGELOG.md",
    "dist",
    "src"
  ],
  "keywords": [
    "bupkis",
    "chai",
    "codemod",
    "migration",
    "assertions"
  ],
  "scripts": {
    "build": "tsc",
    "test": "npm run test:base -- \"test/**/*.test.ts\"",
    "test:base": "node --test --test-reporter=spec --import tsx",
    "test:dev": "npm run test:base -- --watch \"test/**/*.test.ts\""
  },
  "dependencies": {
    "@boneskull/bargs": "4.0.0",
    "bupkis": "0.15.0",
    "ts-morph": "^25.0.0"
  },
  "devDependencies": {
    "chai": "^5.0.0",
    "chai-as-promised": "^8.0.0"
  },
  "publishConfig": {
    "access": "public",
    "provenance": true,
    "registry": "https://registry.npmjs.org/"
  },
  "prettier": {
    "jsdocCommentLineStrategy": "keep",
    "jsdocPreferCodeFences": true,
    "plugins": [
      "prettier-plugin-jsdoc",
      "prettier-plugin-pkg",
      "prettier-plugin-sort-json"
    ],
    "singleQuote": true,
    "tsdoc": true
  }
}
```

**Step 2: Create tsconfig.json**
```json
{
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "declaration": true,
    "declarationMap": true,
    "noEmit": false,
    "rewriteRelativeImportExtensions": true
  },
  "exclude": ["node_modules", "dist", "test"],
  "extends": "../../tsconfig.json",
  "include": ["src/**/*.ts"]
}
```

**Step 3: Copy LICENSE.md from from-jest**
Copy content from `packages/from-jest/LICENSE.md`

**Step 4: Create minimal README.md**
```markdown
# @bupkis/from-chai

Migrate Chai assertions to [bupkis](https://github.com/boneskull/bupkis) with a single command.

## Installation

\`\`\`bash
npx @bupkis/from-chai
\`\`\`

## Usage

\`\`\`bash
# Transform all test files in current directory
npx @bupkis/from-chai

# Dry run (see what would change)
npx @bupkis/from-chai --dry-run

# Strict mode (fail on any unsupported assertion)
npx @bupkis/from-chai --strict
\`\`\`

See full documentation below.
```

**Step 5: Install dependencies**
Run: `npm install`

**Step 6: Commit**
```bash
git add packages/from-chai
git commit -m "chore(from-chai): scaffold package structure"
```

---

### Task 2: Types Module

**Files:**
- Create: `packages/from-chai/src/types.ts`
- Test: `packages/from-chai/test/types.test.ts`

**Step 1: Write the failing test**
```typescript
// packages/from-chai/test/types.test.ts
import { expect } from 'bupkis';
import { describe, it } from 'node:test';

import type {
  ChaiStyle,
  MatcherTransform,
  TransformMode,
} from '../src/types.js';

describe('types', () => {
  it('should export ChaiStyle type with bdd and tdd variants', () => {
    const bdd: ChaiStyle = 'bdd';
    const tdd: ChaiStyle = 'tdd';
    expect(bdd, 'to be', 'bdd');
    expect(tdd, 'to be', 'tdd');
  });

  it('should export TransformMode type', () => {
    const mode: TransformMode = 'best-effort';
    expect(mode, 'to be', 'best-effort');
  });

  it('should define MatcherTransform with required fields', () => {
    const transform: MatcherTransform = {
      bupkisPhrase: 'to be',
      chaiMatcher: 'equal',
      style: 'bdd',
    };
    expect(transform.bupkisPhrase, 'to be', 'to be');
    expect(transform.chaiMatcher, 'to be', 'equal');
    expect(transform.style, 'to be', 'bdd');
  });
});
```

**Step 2: Run test to verify it fails**
Run: `npm run test --workspace=@bupkis/from-chai`
Expected: FAIL - Cannot find module '../src/types.js'

**Step 3: Write minimal implementation**
```typescript
// packages/from-chai/src/types.ts
/**
 * Chai assertion style: BDD (expect/should) or TDD (assert).
 */
export type ChaiStyle = 'bdd' | 'tdd';

/**
 * Result of transforming a single file.
 */
export interface FileTransformResult {
  /** Errors that prevented transformation */
  errors: TransformError[];

  /** Absolute path to the file */
  filePath: string;

  /** Whether the file was modified */
  modified: boolean;

  /** Number of transformations applied */
  transformCount: number;

  /** Warnings for manual review */
  warnings: TransformWarning[];
}

/**
 * A matcher transformation definition.
 */
export interface MatcherTransform {
  /** Bupkis phrase (e.g., 'to be', 'to deep equal') */
  bupkisPhrase: string;

  /** Chai matcher/assertion name (e.g., 'equal', 'isTrue') */
  chaiMatcher: string;

  /** Whether this is a BDD or TDD style matcher */
  style: ChaiStyle;

  /**
   * Optional transformer for complex cases. Return null to skip transformation
   * (will add TODO comment).
   */
  transform?: (args: MatcherTransformArgs) => null | string;
}

/**
 * Arguments passed to custom matcher transformers.
 */
export interface MatcherTransformArgs {
  /** Arguments passed to the Chai matcher */
  matcherArgs: string[];

  /** Whether the assertion is negated (.not or assert.notXxx) */
  negated: boolean;

  /** The full original expression for context */
  originalExpression: string;

  /** The subject being tested (the value passed to expect()) */
  subject: string;
}

/**
 * Error during transformation.
 */
export interface TransformError {
  /** Column number in source (if applicable) */
  column?: number;

  /** Line number in source (if applicable) */
  line?: number;

  /** Error message */
  message: string;
}

/**
 * Mode for handling ambiguous or unsupported transformations.
 */
export type TransformMode = 'best-effort' | 'interactive' | 'strict';

/**
 * Options for the transform function.
 */
export interface TransformOptions {
  /**
   * Working directory for resolving files.
   *
   * @default process.cwd()
   */
  cwd?: string;

  /**
   * File patterns to exclude (glob).
   */
  exclude?: string[];

  /**
   * File patterns to include (glob).
   */
  include?: string[];

  /**
   * How to handle ambiguous transformations.
   *
   * @default 'best-effort'
   */
  mode?: TransformMode;

  /**
   * Whether to write changes to disk.
   *
   * @default true
   */
  write?: boolean;
}

/**
 * Overall result of a transform operation.
 */
export interface TransformResult {
  /** Results for each file processed */
  files: FileTransformResult[];

  /** Total files modified */
  modifiedFiles: number;

  /** Total errors across all files */
  totalErrors: number;

  /** Total files processed */
  totalFiles: number;

  /** Total transformations applied */
  totalTransformations: number;

  /** Total warnings across all files */
  totalWarnings: number;
}

/**
 * Warning about a transformation that needs manual review.
 */
export interface TransformWarning {
  /** Column number in source */
  column: number;

  /** Line number in source */
  line: number;

  /** Description of what needs manual review */
  message: string;

  /** The original code that couldn't be fully transformed */
  originalCode: string;
}
```

**Step 4: Run test to verify it passes**
Run: `npm run test --workspace=@bupkis/from-chai`
Expected: PASS

**Step 5: Commit**
```bash
git add packages/from-chai/src/types.ts packages/from-chai/test/types.test.ts
git commit -m "feat(from-chai): add type definitions"
```

---

### Task 3: BDD Matchers (expect/should style)

**Files:**
- Create: `packages/from-chai/src/matchers/bdd.ts`
- Test: `packages/from-chai/test/matchers/bdd.test.ts`

**Step 1: Write the failing test**
```typescript
// packages/from-chai/test/matchers/bdd.test.ts
import { expect } from 'bupkis';
import { describe, it } from 'node:test';

import { bddMatchers, getBddMatcher } from '../src/matchers/bdd.js';

describe('BDD matchers', () => {
  describe('bddMatchers', () => {
    it('should include equal matcher', () => {
      const matcher = bddMatchers.find((m) => m.chaiMatcher === 'equal');
      expect(matcher, 'to be defined');
      expect(matcher?.bupkisPhrase, 'to be', 'to be');
    });

    it('should include deep.equal matcher', () => {
      const matcher = bddMatchers.find((m) => m.chaiMatcher === 'deep.equal');
      expect(matcher, 'to be defined');
      expect(matcher?.bupkisPhrase, 'to be', 'to deep equal');
    });

    it('should include be.true matcher', () => {
      const matcher = bddMatchers.find((m) => m.chaiMatcher === 'be.true');
      expect(matcher, 'to be defined');
      expect(matcher?.bupkisPhrase, 'to be', 'to be true');
    });
  });

  describe('getBddMatcher', () => {
    it('should return matcher for known chain', () => {
      const matcher = getBddMatcher('equal');
      expect(matcher, 'to be defined');
      expect(matcher?.bupkisPhrase, 'to be', 'to be');
    });

    it('should return undefined for unknown chain', () => {
      const matcher = getBddMatcher('unknownMatcher');
      expect(matcher, 'to be undefined');
    });
  });
});
```

**Step 2: Run test to verify it fails**
Run: `npm run test --workspace=@bupkis/from-chai`
Expected: FAIL - Cannot find module

**Step 3: Write minimal implementation**

Create `packages/from-chai/src/matchers/bdd.ts` with BDD-style matchers including:
- Equality: `equal`, `deep.equal`, `eql`
- Truthiness: `be.true`, `be.false`, `be.null`, `be.undefined`, `exist`, `be.ok`
- Type checking: `be.a`, `be.an`, `be.instanceof`
- Numbers: `be.above`, `be.below`, `be.within`, `be.closeTo`
- Strings: `match`, `contain`, `include`
- Arrays/Collections: `have.length`, `be.empty`
- Objects: `have.property`, `have.keys`
- Errors: `throw`, `throws`

**Step 4: Run test to verify it passes**

**Step 5: Commit**
```bash
git add packages/from-chai/src/matchers/bdd.ts packages/from-chai/test/matchers/bdd.test.ts
git commit -m "feat(from-chai): add BDD-style matcher definitions"
```

---

### Task 4: TDD Matchers (assert style)

**Files:**
- Create: `packages/from-chai/src/matchers/tdd.ts`
- Test: `packages/from-chai/test/matchers/tdd.test.ts`

Follow same pattern as Task 3 but for TDD-style `assert.xxx()` calls.

---

### Task 5: Plugin Matchers (chai-as-promised, chai-string, chai-subset)

**Files:**
- Create: `packages/from-chai/src/matchers/plugins.ts`
- Create: `packages/from-chai/src/matchers/index.ts`
- Test: `packages/from-chai/test/matchers/plugins.test.ts`

Include support for:
- **chai-as-promised**: `eventually.equal`, `be.fulfilled`, `be.rejected`, `be.rejectedWith`
- **chai-string**: `startWith`, `endWith`
- **chai-subset**: `containSubset`

---

### Task 6: BDD Expect Transformer

**Files:**
- Create: `packages/from-chai/src/transformers/bdd-transformer.ts`
- Test: `packages/from-chai/test/transformers/bdd-transformer.test.ts`

Transform Chai BDD expect() chains to bupkis syntax. Handle:
- `expect(x).to.equal(y)` → `expect(x, 'to be', y)`
- `expect(x).to.deep.equal(y)` → `expect(x, 'to deep equal', y)`
- `expect(x).to.be.true` → `expect(x, 'to be true')`
- `expect(x).to.not.equal(y)` → `expect(x, 'not to be', y)`
- `expect(x).not.to.equal(y)` → `expect(x, 'not to be', y)`

---

### Task 7: TDD Assert Transformer

**Files:**
- Create: `packages/from-chai/src/transformers/tdd-transformer.ts`
- Test: `packages/from-chai/test/transformers/tdd-transformer.test.ts`

Transform Chai TDD assert.xxx() calls to bupkis syntax. Handle:
- `assert.equal(x, y)` → `expect(x, 'to be', y)`
- `assert.isTrue(x)` → `expect(x, 'to be true')`
- `assert.notEqual(x, y)` → `expect(x, 'not to be', y)`

---

### Task 8: Import Transformer

**Files:**
- Create: `packages/from-chai/src/transformers/import-transformer.ts`
- Test: `packages/from-chai/test/transformers/import-transformer.test.ts`

Replace Chai imports with bupkis. Handle:
- `import { expect } from 'chai'` → `import { expect } from 'bupkis'`
- `import { assert } from 'chai'` → `import { expect } from 'bupkis'`
- Remove `chai.use()` calls
- Remove chai plugin imports (chai-as-promised, etc.)

---

### Task 9: Main Transform API

**Files:**
- Create: `packages/from-chai/src/transform.ts`
- Test: `packages/from-chai/test/transform.test.ts`

Orchestrate all transformers and provide the main `transform()` and `transformCode()` functions.

---

### Task 10: CLI Implementation

**Files:**
- Create: `packages/from-chai/src/cli.ts`
- Create: `packages/from-chai/src/index.ts`
- Test: `packages/from-chai/test/cli.test.ts`

CLI with:
- `--dry-run` - Show changes without writing
- `--strict` - Fail on any unsupported assertion
- `--best-effort` - Transform what we can, add TODOs for the rest (default)
- `--exclude` - Patterns to exclude
- Positional patterns for files to include

---

### Task 11: Integration Tests and Fixtures

**Files:**
- Create: `packages/from-chai/test/fixtures/chai-example.ts`
- Create: `packages/from-chai/test/fixtures/expected.ts`
- Create: `packages/from-chai/test/integration.test.ts`

End-to-end tests with real Chai code transformed to expected bupkis output.

---

### Task 12: Documentation

**Files:**
- Modify: `packages/from-chai/README.md`

Comprehensive README with all supported matchers, CLI usage, programmatic API, and migration notes.

---

### Task 13: Final Build and Verification

**Step 1: Build the package**
Run: `npm run build --workspace=@bupkis/from-chai`

**Step 2: Run all tests**
Run: `npm run test --workspace=@bupkis/from-chai`

**Step 3: Run linting from root**
Run: `npm run lint`

**Step 4: Test CLI manually**
Run: `npx tsx packages/from-chai/src/cli.ts --help`

**Step 5: Final commit**
```bash
git add .
git commit -m "feat(from-chai): complete @bupkis/from-chai codemod package

Adds a new codemod package to migrate Chai assertions to bupkis.

Features:
- BDD style (expect/should) support
- TDD style (assert) support
- chai-as-promised plugin support
- chai-string plugin support
- chai-subset plugin support
- CLI and programmatic API
- --dry-run, --strict, --best-effort modes

Closes #321"
```

---

### Critical Files for Implementation

1. **`packages/from-jest/src/transformers/expect-transformer.ts`** - AST traversal pattern to adapt for Chai's chainable API
2. **`packages/from-jest/src/matchers/core.ts`** - Matcher definition pattern to follow for defining Chai matchers
3. **`packages/from-jest/src/transform.ts`** - Main transform API structure to replicate
4. **`packages/from-jest/src/types.ts`** - Types to extend (add ChaiStyle, adapt MatcherTransform)
5. **`packages/from-jest/package.json`** - Package structure and dependencies to mirror
